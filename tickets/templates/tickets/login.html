{% extends "tickets/base_no_nav.html" %} 
{% load static %}

{% block messages %}
    {% endblock %}

{% block title %}Login - Portal de Suporte{% endblock %}

{% block content %}

<style>
    /* --- CONFIGURAÇÃO DA IMAGEM DE FUNDO --- */
    .hero-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw; /* Garante 100% da largura da janela (Viewport Width) */
        
        /* Ajuste a altura aqui. 
           Se a imagem estiver cortando muito embaixo, aumente esse valor. */
        height: 100vh; 

        background-image: url('{% static "tickets/img/fundo_login.jpg" %}');
        
        /* --- A SOLUÇÃO MÁGICA --- */
        
        /* 'cover': Faz a imagem crescer até preencher TODO o espaço.
           Isso elimina as barras laterais brancas. */
        background-size: 100% 100%; 
        
        /* 'top center': Isso diz ao navegador: 
           "Preencha tudo, mas se tiver que cortar algo, corte as laterais ou o fundo.
            NUNCA corte o topo (cabeçalho) e tente manter o centro focado." */
        background-position: top center; 
        
        background-repeat: no-repeat;
        z-index: -1;
        
        border-bottom: 4px solid var(--ibm-blue-60); 
    }

    /* Opcional: Em telas muito largas (Monitores Ultrawide), ajustamos para não cortar tanto */
    @media (min-width: 1900px) {
        .hero-background {
            background-position: center 30%; /* Sobe um pouco o foco */
        }
    }

    /* Camada Escura para melhorar leitura (Opcional) */
    .hero-background::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to bottom, rgba(0,0,0,0.5), rgba(0,0,0,0.1));
    }

</style>

<div class="hero-background"></div>

<div class="container d-flex align-items-center justify-content-center" style="min-height: 80vh;">
    <div class="card login-container w-100 shadow-sm">
        <div class="card-body">
            <div class="text-center mb-4">
                <h3 class="fw-bold mb-1">Bem-vindo</h3>
                <p class="text-muted small">Faça login para acessar o Portal de Suporte</p>
            </div>

            {% if form.errors %}
                <div id="generalErrorAlert" class="text-center mb-4 fade show">
                    <div class="d-inline-flex align-items-center text-danger fw-bold small">
                        <i class="fa-solid fa-circle-exclamation me-2"></i>
                        {% if form.non_field_errors %}
                            <span>{{ form.non_field_errors.0 }}</span>
                        {% else %}
                             <span>Preencha os campos obrigatórios abaixo.</span>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <form method="post" id="loginForm" novalidate>
                {% csrf_token %}
                
                <div class="form-floating mb-3">
                    <input type="text" name="username" 
                           class="form-control {% if form.username.errors %}is-invalid{% endif %}" 
                           id="floatingInput" 
                           placeholder="seu@email.com" 
                           value="{{ form.username.value|default:'' }}" 
                           autofocus>
                    <label for="floatingInput">E-mail</label>
                    
                    {% if form.username.errors %}
                        <div class="invalid-feedback text-start">
                            {{ form.username.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <div class="form-floating mb-4">
                    <input type="password" name="password" 
                           class="form-control {% if form.password.errors %}is-invalid{% endif %}" 
                           id="floatingPassword" 
                           placeholder="Senha">
                    <label for="floatingPassword">Senha</label>
                    
                    {% if form.password.errors %}
                        <div class="invalid-feedback text-start">
                            {{ form.password.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                        <i class="fa-solid fa-arrow-right-to-bracket me-2" id="btnIcon"></i>
                        <span class="btn-text">Entrar</span>
                    </button>
                </div>
            </form>
            
            <div class="text-center mt-4">
                <small class="text-muted">Esqueceu a senha? Contate o suporte <a href="mailto:suportebr@itconsol.com" class="text-decoration-none text-muted fw-bold">suportebr@itconsol.com</a></small>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Feedback visual ao Enviar (Spinner)
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            var btn = document.getElementById('btnSubmit');
            var spinner = btn.querySelector('.spinner-border');
            var text = btn.querySelector('.btn-text');
            var icon = document.getElementById('btnIcon');
            
            // Ativa o estado de carregamento
            btn.classList.add('disabled'); 
            spinner.classList.remove('d-none'); // Mostra spinner
            icon.classList.add('d-none');       // Esconde ícone de porta
            text.innerText = "Entrando...";     // Muda texto
        });

        // 2. Limpar erros ao digitar (Lógica Inteligente)
        var invalidFields = document.querySelectorAll('.is-invalid');
        var generalAlert = document.getElementById('generalErrorAlert');

        invalidFields.forEach(function(field) {
            var checkRemainingErrors = function() {
                // a) Remove o vermelho deste campo
                if (field.classList.contains('is-invalid')) {
                    field.classList.remove('is-invalid');
                }

                // b) Verifica se ainda existe algum campo vermelho na tela
                var remainingErrors = document.querySelectorAll('.is-invalid').length;

                // c) Se não sobrar nenhum erro, esconde o alerta do topo
                if (remainingErrors === 0 && generalAlert) {
                    generalAlert.classList.add('d-none');
                }
            };

            // Dispara ao digitar
            field.addEventListener('input', checkRemainingErrors);
        });
    });
</script>
{% endblock %}